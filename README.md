# Butter Fly
****************************************************************

### 贾一帆、邓卓 、陈灿思 
#### 卓俊之光

### 个人主页：
#### 贾一帆：[LOFTER ]( http://nottechnology.lofter.com/)


*************************************************************************
##目录
###  [项目说明](#项目说明)
###  [引脚说明](#引脚说明)
### [功能说明](#功能说明)
### [代码版本分支](#代码版本分支)
### [过程记录](#过程记录)
*************************************************************************
## <a name = "项目说明" />项目说明
**2015/7/4 19:46:06**   
基于STM32F1系列微控制器的四旋翼飞行控制器，用于挑战无人机自动控制。
*************************************************************************
## <a name = "引脚说明" />引脚说明
*************************************************************************
## <a name = "功能说明" />功能说明
### 目录
[HC-05](#HC-05)
************************************************
### <a name = "HC-05"/>HC-05
**2015/7/4 22:14:12**    
HC-05蓝牙串口模块，用于微控制器与上位机通讯。  
**2015-07-06 16:26:56**  
使用DMA作为发送与接收通道，提高CPU效率
*************************************************************************
## <a name = "代码版本分支"/>代码版本分支  
### 分支目录  
####  主线分支  
#### [master](#master)   
#### [dev](#dev)  

#### feature分支  
##### [HC-05](#HC-05branch)
*********************************************************
### <a name = "master" />master分支  
#### 分支说明 
发布稳定版本的分支  
#### 版本号目录  
[0234ef1](#0234ef1master)  
[d82a586](#d82a586master)  

#### <a name = "0234ef1master" />0234ef1  
新建空白工程  
#### <a name = "d82a586master" />d82a586  
初始化git 版本库  

_________________________________________
### <a name = "dev" />dev分支  
#### 分支说明  
发布待稳定版本的分支  
#### 版本号目录  
[3f36b67](#3f36b67)  
[0234ef1](#0234ef1)  
[d82a586](#d82a586)  

_ _ _

#### <a name = "3f36b67" />3f36b67  
July 6, 2015 8:45 PM  
合并HC-05外设程序  
#### <a name = "0234ef1" />0234ef1  
新建空白工程  
#### <a name = "d82a586" />d82a586  
初始化git 版本库  
_________________________________________
### <a name = "HC-05branch" />  HC-05 
#### 分支说明 (该分支已删除)
**2015-07-06 16:31:07**  
HC-05蓝牙串口 通讯模块  
可用串口：USART1~USART3  
关键文件：`hc05.c`，`hc05.h`  
使用方法：    
1. 在`hc05.h`的`Define`中，定义是否使用DMA发送、DMA接收（默认使能）    
2. 在`hc05.h`的`Define`中，定义发送和接收数组长度  
3. 在`hc05.h`的`Define`中，定义Key和LED引脚  
4. 在程序开始前，对结构体参数如下赋值： 
``` C  
	/* HC05 -------------------------------------------------------*/  
	HC05.USARTBASE = USART2;		//使用串口2	  
	HC05.KeyBase = GPIOC_BASE;		//Key引脚  
	HC05.KeyPin = GPIO_Pin_7;  

	HC05.LEDBase = GPIOC_BASE;		//LED引脚  
	HC05.LEDPin = GPIO_Pin_8;   
```   
5. 调用`HC05Init(&HC05)`函数，若检测到HC-05模块，返回值为ErrorStatus类型的SUCCESS  
6. 检测成功后，可与配对的蓝牙模块互发数据
7. 发送方法一：使用`HC05printf`函数（此函数用法与printf函数相同）
``` c
    void HC05printf(HC05Str * HC05,DMA_Channel_TypeDef*DMA_CHx,char* fmt,...)
    例： HC05printf(&HC05,DMA1_Channel7,"print a float %f\r\n",102.324);    //函数内已包含检测上一次传输是否完成的函数
```
8. 方法二：使用`UARTxDMASend`函数  
写好`HC05.TxData`数组内容，然后将需要发送的字节数与DMA通道号（USART2为通道7）作为参数开启一次DMA传输
``` c
UARTxDMASend(DMA_Channel_TypeDef * DMA_CHx,u16 Len);  
例：for(i = 0;i<HC05.RxLen;i++)HC05.TxData[i] = HC05.RxData[i];  
while(DMA1_Channel7->CNDTR!=0);	    //检查上一次传输是否完成
UARTxDMASend(DMA1_Channel7,HC05.RxLen);  
```

9. 接收使用USART空闲中断，中断中得到接收到的数据包长度，并且进行处理，详情见`hc05.c`中串口2的中断服务函数
******************************************************************************
## <a name = "过程记录" /> 过程记录
**2015-07-04 22:42:10**   
HC-05蓝牙串口模块，使用绑定地址模式，并设置相应地址，可达到一一对应连接的效果。  
**2015-07-06 16:16:23**  
使用DMA发送 前，要先用    
```
while(DMA1_Channel7->CNDTR!=0);	
```  
判断DMA是否完成上一次传输
**July 7, 2015 5:01 PM**  
修复一个BUG，CNDTR寄存器复位值为0x0032，该BUG使第一次执行HC05Printf时陷入死循环。  
在DMAInit()函数后用软件将该寄存器的值设置为0。
**July 9, 2015 5:54 PM**  
与KS103通过IIC通讯，需要接上拉电阻